name: Preview Hosting on PR to dev
on:
    pull_request:
        branches: [dev] # PRs into dev
permissions:
    contents: read
    pull-requests: write
    checks: write

jobs:
    preview:
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        runs-on: ubuntu-latest
        concurrency:
            group: preview-${{ github.event.pull_request.number }}
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17

            - uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: flutter pub get
              run: flutter pub get

            - name: Build Flutter Web
              run: flutter build web --release --no-tree-shake-icons

            - name: Deploy preview channel
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: ${{ secrets.GITHUB_TOKEN }}
                  firebaseServiceAccount: ${{ secrets.firebaseservice_accountkey}}
                  projectId: fih-superset-dev
                  channelId: preview # ephemeral per-PR
                  entryPoint: .
