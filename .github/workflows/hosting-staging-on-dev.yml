name: Deploy Staging on dev

on:
    push:
        branches: [dev]

jobs:
    staging:
        runs-on: ubuntu-latest
        concurrency:
            group: staging-dev
            cancel-in-progress: true

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 17

            - uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: flutter pub get
              run: flutter pub get

            - name: Build Flutter Web
              run: flutter build web --release --no-tree-shake-icons

            - name: Upload built web (artifact)
              uses: actions/upload-artifact@v4
              with:
                  name: flutter-web-build-staging
                  path: build/web

            - name: Skip deploy (no Firebase secret)
              if: ${{ secrets.firebaseservice_accountkey == '' }}
              run: echo "::notice::Firebase deploy skipped (no secret found)"

            - name: Deploy to Firebase Hosting (staging)
              if: ${{ secrets.firebaseservice_accountkey != '' }}
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: ${{ secrets.GITHUB_TOKEN }}
                  firebaseServiceAccount: ${{ secrets.firebaseservice_accountkey }}
                  projectId: fih-superset-dev
                  channelId: staging
                  entryPoint: .
